@model ApiPaginatedListResult<ObservationGetViewModel>
@{
    ViewData["Title"] = "Observations";
    Layout = "~/Views/MainLayout/Index.cshtml";
}

<!--begin::Card-->
<div class="card">
    <div class="card-header border-0 pt-6">
        <!--begin::Card title-->
        <div class="card-title">
            <!--begin::Search-->
            <div class="d-flex align-items-center position-relative my-1">
                <span class="svg-icon svg-icon-1 position-absolute ms-6">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect opacity="0.5" x="17.0365" y="15.1223" width="8.15546" height="2" rx="1" transform="rotate(45 17.0365 15.1223)" fill="currentColor"></rect>
                        <path d="M11 19C6.55556 19 3 15.4444 3 11C3 6.55556 6.55556 3 11 3C15.4444 3 19 6.55556 19 11C19 15.4444 15.4444 19 11 19ZM11 5C7.53333 5 5 7.53333 5 11C5 14.4667 7.53333 17 11 17C14.4667 17 17 14.4667 17 11C17 7.53333 14.4667 5 11 5Z" fill="currentColor"></path>
                    </svg>
                </span>
                <input type="text" id="searchInput" class="form-control form-control-solid w-250px ps-14" placeholder="Search Observations">
            </div>
            <!--end::Search-->
        </div>
        <!--end::Card title-->
        <!--begin::Card toolbar-->
        <div class="card-toolbar">
            <!--begin::Toolbar-->
            <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-light-dark" data-bs-toggle="modal" data-bs-target="#kt_createmodal_observation">
                    <span class="svg-icon svg-icon-2">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect opacity="0.5" x="11.364" y="20.364" width="16" height="2" rx="1" transform="rotate(-90 11.364 20.364)" fill="currentColor"></rect>
                            <rect x="4.36396" y="11.364" width="16" height="2" rx="1" fill="currentColor"></rect>
                        </svg>
                    </span>
                    New Observation
                </button>
            </div>
            <!--end::Toolbar-->
        </div>
        <!--end::Card toolbar-->
    </div>
    <!--begin::Card body-->
    <div class="card-body py-4">
        <!--begin::Table-->
        <table class="table align-middle table-row-dashed fs-6 gy-5" id="observationTable">
            <thead>
                <tr class="text-start text-gray-400 fw-bold fs-7 text-uppercase gs-0">
                    <th>Id</th>
                    <th>Genus Name</th>
                    <th>Family Name</th>
                    <th>Scientific Name</th>
                    <th>Hesselbarth Name</th>
                    <th>Province Name</th>
                    <th>Number Seen</th>
                    <th>Observation Date</th>
                    <th></th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody class="text-gray-600 fw-semibold">
                @foreach (var item in Model.Items)
                {
                    <tr>
                        <td>@item.Id</td>
                        <td>@(item.GenusName ?? "-")</td>
                        <td>@(item.FamilyName ?? "-")</td>
                        <td>@(item.ScientificName ?? "-")</td>
                        <td>@(item.HesselbarthName ?? "-")</td>
                        <td>@(item.ProvinceName ?? "-")</td>
                        <td>@item.NumberSeen</td>
                        <td>@item.ObservationDate.ToString("dd/MM/yyyy")</td>
                        <td>
                            <a href="javascript:;"
                               data-observation='@Html.Raw(Json.Serialize(item))'
                               class="btn btn-light btn-active-light-primary btn-sm view-details">
                                <i class="fas fa-eye"></i> Details
                            </a>
                        </td>
                        <td>
                            <div class="d-flex justify-content-center">
                                <a href="javascript:;" onclick="confirmDelete(@item.Id)"
                                   class="btn btn-icon btn-bg-light btn-active-color-danger btn-sm me-2">
                                    <i class="fas fa-trash text-danger"></i>
                                </a>
                                <a href="javascript:;" onclick="updateObservation(@item.Id)"
                                   class="btn btn-icon btn-bg-light btn-active-color-primary btn-sm">
                                    <i class="fas fa-edit text-primary"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        <!--end::Table-->
        <!--begin::Pagination-->
        <div class="d-flex flex-stack flex-wrap pt-10">
            <div class="fs-6 fw-semibold text-gray-700">
                Showing @((Model.PageNumber - 1) * 25 + 1) to @Math.Min(Model.PageNumber * 25, Model.TotalCount) of @Model.TotalCount entries
            </div>
            <ul class="pagination">
                @{
                    var maxVisiblePages = 5;
                    var currentPage = Model.PageNumber;
                    var totalPages = Model.TotalPages;

                    // Sayfa aralığını hesapla
                    var halfVisible = (maxVisiblePages - 1) / 2;
                    var startPage = Math.Max(1, currentPage - halfVisible);
                    var endPage = Math.Min(totalPages, startPage + maxVisiblePages - 1);

                    // Start page'i yeniden ayarla eğer endPage max'a ulaşamadıysa
                    if (endPage - startPage + 1 < maxVisiblePages)
                    {
                        startPage = Math.Max(1, endPage - maxVisiblePages + 1);
                    }
                }

                <!--begin::Previous-->
                <li class="page-item previous @(!Model.HasPreviousPage ? "disabled" : "")">
                    @if (Model.HasPreviousPage)
                    {
                        <a href="javascript:;" onclick="loadPage(@(Model.PageNumber - 1))" class="page-link">
                            <i class="previous"></i>
                        </a>
                    }
                    else
                    {
                        <span class="page-link"><i class="previous"></i></span>
                    }
                </li>
                <!--end::Previous-->
                <!--begin::First page-->
                @if (startPage > 1)
                {
                    <li class="page-item">
                        <a href="javascript:;" onclick="loadPage(1)" class="page-link">1</a>
                    </li>
                    @if (startPage > 2)
                    {
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    }
                }
                <!--end::First page-->
                <!--begin::Pages-->
                @for (var i = startPage; i <= endPage; i++)
                {
                    <li class="page-item @(i == currentPage ? "active" : "")">
                        <a href="javascript:;" onclick="loadPage(@i)" class="page-link">@i</a>
                    </li>
                }
                <!--end::Pages-->
                <!--begin::Last page-->
                @if (endPage < totalPages)
                {
                    @if (endPage < totalPages - 1)
                    {
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    }
                    <li class="page-item">
                        <a href="javascript:;" onclick="loadPage(@totalPages)" class="page-link">@totalPages</a>
                    </li>
                }
                <!--end::Last page-->
                <!--begin::Next-->
                <li class="page-item next @(!Model.HasNextPage ? "disabled" : "")">
                    @if (Model.HasNextPage)
                    {
                        <a href="javascript:;" onclick="loadPage(@(Model.PageNumber + 1))" class="page-link">
                            <i class="next"></i>
                        </a>
                    }
                    else
                    {
                        <span class="page-link"><i class="next"></i></span>
                    }
                </li>
                <!--end::Next-->
            </ul>
        </div>
        <!--end::Pagination-->
    </div>
    <!--end::Card body-->
</div>
<!--end::Card-->
<!--begin::DetailModal-->
<div class="modal fade" id="kt_modal_observation" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content rounded">
            <div class="modal-header pb-0 border-0 justify-content-end">
                <div class="btn btn-sm btn-icon btn-active-color-primary" data-bs-dismiss="modal">
                    <i class="ki-duotone ki-cross fs-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </div>
            </div>

            <div class="modal-body scroll-y px-10 px-lg-15 pt-0 pb-15">
                <div class="mb-13 text-center">
                    <h1 class="mb-3">Observation Details</h1>
                </div>

                <!--begin::Classification Card-->
                <div class="card shadow-sm mb-8 modal-section">
                    <div class="card-header">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold text-dark">Classification Information</span>
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-5 g-xl-8">
                            <div class="col-xl-6">
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Scientific Name</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalScientificName"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Family Name</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalFamilyName"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Genus Name</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalGenusName"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">EU Name</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalEuName"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Full Name</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalFullName"></div>
                                </div>
                            </div>
                            <div class="col-xl-6">
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Turkish Name</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalTurkishName"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">English Name</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalEnglishName"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Authority</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalAuthority"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Name</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalName"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Turkish Names Trakel</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalTurkishNamesTrakel"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Trakel</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalTrakel"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--end::Classification Card-->
                <!--begin::Location Card-->
                <div class="card shadow-sm mb-8 modal-section">
                    <div class="card-header">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold text-dark">Location Details</span>
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-5 g-xl-8">
                            <div class="col-xl-6">
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Province</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalProvince"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Coordinates</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalCoordinates"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Square Reference</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalSquareRef"></div>
                                </div>
                            </div>
                            <div class="col-xl-6">
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Altitude</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalAltitude"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">UTM Reference</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalUtmReference"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Location Info</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalLocationInfo"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Coordinate Precision Level</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalCoordinatePrecisionLevel"></div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
                <!--end::Location Card-->
                <!--begin::Observation Card-->
                <div class="card shadow-sm modal-section">
                    <div class="card-header">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold text-dark">Observation Details</span>
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-5 g-xl-8">
                            <div class="col-xl-6">
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Observer</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalObserver"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Date</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalObservationDate"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Number Seen</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalNumberSeen"></div>
                                </div>
                            </div>
                            <div class="col-xl-6">
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Sex</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalSex"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Life Stage</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalLifeStage"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Notes</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalNotes"></div>
                                </div>
                            </div>
                        </div>
                        <div class="field-container mb-5">
                            <div class="fs-6 fw-semibold mb-2">Source</div>
                            <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalSource"></div>
                        </div>
                    </div>
                </div>
                <!--end::Observation Card-->
            </div>
        </div>
    </div>
</div>
<!--end::DetailModal-->
<!--begin::UpdateModal-->
<div class="modal fade" id="kt_updatemodal_observation" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content rounded">
            <div class="modal-header pb-0 border-0 justify-content-end">
                <div class="btn btn-sm btn-icon btn-active-color-primary" data-bs-dismiss="modal">
                    <i class="ki-duotone ki-cross fs-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </div>
            </div>

            <div class="modal-body scroll-y px-10 px-lg-15 pt-0 pb-15">
                <div class="mb-13 text-center">
                    <h1 class="mb-3">Observation Update</h1>
                </div>
                <form id="update_observation_form">
                    <!--begin::Classification Card-->
                    <div class="card shadow-sm mb-8 modal-section">
                        <div class="card-header">
                            <h3 class="card-title align-items-start flex-column">
                                <span class="card-label fw-bold text-dark">Classification Information</span>
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="row g-5 g-xl-8">
                                <div class="col-xl-6">
                                    <input type="hidden" name="id" id="updateId" />
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Scientific Name</div>
                                        <input class="form-control" name="scientificName" type="text" id="updateScientificName" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Family Name</div>
                                        <input class="form-control" name="familyName" type="text" id="updateFamilyName" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Genus Name</div>
                                        <input class="form-control" name="genusName" type="text" id="updateGenusName" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">EU Name</div>
                                        <input class="form-control" name="euName" type="text" id="updateEUName" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Full Name</div>
                                        <input class="form-control" name="fullName" type="text" id="updateFullName" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Kocak Name</div>
                                        <input class="form-control" name="kocakName" type="text" id="updateKocakName" />
                                    </div>
                                </div>
                                <div class="col-xl-6">
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Turkish Name</div>
                                        <input class="form-control" name="turkishName" type="text" id="updateTurkishName" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">English Name</div>
                                        <input class="form-control" name="englishName" type="text" id="updateEnglishName" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Authority</div>
                                        <input class="form-control" name="authority" type="text" id="updateAuthority" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Name</div>
                                        <input class="form-control" name="name" type="text" id="updateName" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Turkish Names Trakel</div>
                                        <input class="form-control" name="turkishNamesTrakel" type="text" id="updateTurkishNamesTrakel" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Trakel</div>
                                        <input class="form-control" name="trakel" type="text" id="updateTrakel" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Hesselbarth Name</div>
                                        <input class="form-control" name="hesselbarthName" type="text" id="updateHesselbarthName" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--end::Classification Card-->
                    <!--begin::Location Card-->
                    <div class="card shadow-sm mb-8 modal-section">
                        <div class="card-header">
                            <h3 class="card-title align-items-start flex-column">
                                <span class="card-label fw-bold text-dark">Location Details</span>
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="row g-5 g-xl-8">
                                <div class="col-xl-6">
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Province</div>
                                        <select class="form-select" name="provinceId" id="updateProvinceName">
                                            <option value="">Select Province</option>
                                        </select>
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Square Reference</div>
                                        <input class="form-control" name="squareRef" type="text" id="updateSquareRef" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Square Latitude</div>
                                        <input class="form-control" name="squareLatitude" type="number" step="0.000001" id="updateSquareLatitude" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Square Longitude</div>
                                        <input class="form-control" name="squareLongitude" type="number" step="0.000001" id="updateSquareLongitude" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Latitude</div>
                                        <input class="form-control" name="latitude" type="number" step="0.01" id="updateLatitude" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Decimal Degrees</div>
                                        <input class="form-control" name="decimalDegrees" type="text" id="updateDecimalDegrees" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Degrees Minutes Seconds</div>
                                        <input class="form-control" name="degreesMinutesSeconds" type="text" id="updateDegreesMinutesSeconds" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Decimal Minutes</div>
                                        <input class="form-control" name="decimalMinutes" type="text" id="updateDecimalMinutes" />
                                    </div>
                                </div>
                                <div class="col-xl-6">
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">UTM Coordinates</div>
                                        <input class="form-control" name="utmCoordinates" type="text" id="updateUtmCoordinates" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">MGRS Coordinates</div>
                                        <input class="form-control" name="mgrsCoordinates" type="text" id="updateMgrsCoordinates" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Altitude 1</div>
                                        <input class="form-control" name="altitude1" type="number" step="0.01" id="updateAltitude1" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Altitude 2</div>
                                        <input class="form-control" name="altitude2" type="number" step="0.01" id="updateAltitude2" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Longitude</div>
                                        <input class="form-control" name="longitude" type="number" step="0.01" id="updateLongitude" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">UTM Reference</div>
                                        <input class="form-control" name="utmReference" type="text" id="updateUtmReference" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Location Info</div>
                                        <input class="form-control" name="locationInfo" type="text" id="updateLocationInfo" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Coordinate Precision Level</div>
                                        <select class="form-select" name="coordinatePrecisionLevel" id="updateCoordinatePrecisionLevel">
                                            <option value="0">Tam/Hassas Koordinat</option>
                                            <option value="1">UTM Koordinatı</option>
                                            <option value="2">İlçe Koordinatı</option>
                                            <option value="3">Kare Koordinatı</option>
                                            <option value="4">İl Koordinatı</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--end::Location Card-->
                    <!--begin::Observation Card-->
                    <div class="card shadow-sm modal-section">
                        <div class="card-header">
                            <h3 class="card-title align-items-start flex-column">
                                <span class="card-label fw-bold text-dark">Observation Details</span>
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="row g-5 g-xl-8">
                                <div class="col-xl-6">
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Observer</div>
                                        <input class="form-control" name="observerFullName" type="text" id="updateObserverName" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Date</div>
                                        <input class="form-control" name="observationDate" type="date" id="updateObservationDate" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Number Seen</div>
                                        <input class="form-control" name="numberSeen" type="number" id="updateNumberSeen" />
                                    </div>
                                </div>
                                <div class="col-xl-6">
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Sex</div>
                                        <input class="form-control" name="sex" type="text" id="updateSex" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Life Stage</div>
                                        <input class="form-control" name="lifeStage" type="text" id="updateLifeStage" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Notes</div>
                                        <input class="form-control" name="notes" type="text" id="updateNotes" />
                                    </div>
                                </div>
                            </div>
                            <div class="field-container mb-5">
                                <div class="fs-6 fw-semibold mb-2">Source</div>
                                <input class="form-control" name="source" type="text" id="updateSource" />
                            </div>
                            <div class="text-center mt-15">
                                <button type="button" class="btn btn-light-success" id="updateObservationButton">
                                    <span class="indicator-label">Update</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <!--end::Observation Card-->
                </form>
            </div>
        </div>
    </div>
</div>
<!--end::UpdateModal-->
<!--begin::CreateModal-->
<div class="modal fade" id="kt_createmodal_observation" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content rounded">
            <div class="modal-header pb-0 border-0 justify-content-end">
                <div class="btn btn-sm btn-icon btn-active-color-primary" data-bs-dismiss="modal">
                    <i class="ki-duotone ki-cross fs-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </div>
            </div>

            <div class="modal-body scroll-y px-10 px-lg-15 pt-0 pb-15">
                <div class="mb-13 text-center">
                    <h1 class="mb-3">Create Observation</h1>
                </div>
                <form id="create_observation_form">
                    <!--begin::Classification Card-->
                    <div class="card shadow-sm mb-8 modal-section">
                        <div class="card-header">
                            <h3 class="card-title align-items-start flex-column">
                                <span class="card-label fw-bold text-dark">Classification Information</span>
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="row g-5 g-xl-8">
                                <div class="col-xl-6">
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Scientific Name</div>
                                        <input class="form-control" name="scientificName" type="text" id="createScientificName" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Family Name</div>
                                        <input class="form-control" name="familyName" type="text" id="createFamilyName" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Genus Name</div>
                                        <input class="form-control" name="genusName" type="text" id="createGenusName" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">EU Name</div>
                                        <input class="form-control" name="euName" type="text" id="createEUName" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Full Name</div>
                                        <input class="form-control" name="fullName" type="text" id="createFullName" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Kocak Name</div>
                                        <input class="form-control" name="kocakName" type="text" id="createKocakName" />
                                    </div>
                                </div>
                                <div class="col-xl-6">
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Turkish Name</div>
                                        <input class="form-control" name="turkishName" type="text" id="createTurkishName" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">English Name</div>
                                        <input class="form-control" name="englishName" type="text" id="createEnglishName" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Authority</div>
                                        <input class="form-control" name="authority" type="text" id="createAuthority" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Name</div>
                                        <input class="form-control" name="name" type="text" id="createName" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Turkish Names Trakel</div>
                                        <input class="form-control" name="turkishNamesTrakel" type="text" id="createTurkishNamesTrakel" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Trakel</div>
                                        <input class="form-control" name="trakel" type="text" id="createTrakel" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Hesselbarth Name</div>
                                        <input class="form-control" name="hesselbarthName" type="text" id="createHesselbarthName" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--end::Classification Card-->
                    <!--begin::Location Card-->
                    <div class="card shadow-sm mb-8 modal-section">
                        <div class="card-header">
                            <h3 class="card-title align-items-start flex-column">
                                <span class="card-label fw-bold text-dark">Location Details</span>
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="row g-5 g-xl-8">
                                <div class="col-xl-6">
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Province</div>
                                        <select class="form-select" name="provinceId" id="createProvinceName">
                                            <option value="">Select Province</option>
                                        </select>
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Square Reference</div>
                                        <input class="form-control" name="squareRef" type="text" id="createSquareRef" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Square Latitude</div>
                                        <input class="form-control" name="squareLatitude" type="number" step="0.000001" id="createSquareLatitude" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Square Longitude</div>
                                        <input class="form-control" name="squareLongitude" type="number" step="0.000001" id="createSquareLongitude" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Latitude</div>
                                        <input class="form-control" name="latitude" type="number" step="0.01" id="createLatitude" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Decimal Degrees</div>
                                        <input class="form-control" name="decimalDegrees" type="text" id="createDecimalDegrees" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Degrees Minutes Seconds</div>
                                        <input class="form-control" name="degreesMinutesSeconds" type="text" id="createDegreesMinutesSeconds" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Decimal Minutes</div>
                                        <input class="form-control" name="decimalMinutes" type="text" id="createDecimalMinutes" />
                                    </div>
                                </div>
                                <div class="col-xl-6">
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">UTM Coordinates</div>
                                        <input class="form-control" name="utmCoordinates" type="text" id="createUtmCoordinates" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">MGRS Coordinates</div>
                                        <input class="form-control" name="mgrsCoordinates" type="text" id="createMgrsCoordinates" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Altitude 1</div>
                                        <input class="form-control" name="altitude1" type="number" step="0.01" id="createAltitude1" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Altitude 2</div>
                                        <input class="form-control" name="altitude2" type="number" step="0.01" id="createAltitude2" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Longitude</div>
                                        <input class="form-control" name="longitude" type="number" step="0.01" id="createLongitude" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">UTM Reference</div>
                                        <input class="form-control" name="utmReference" type="text" id="createUtmReference" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Location Info</div>
                                        <input class="form-control" name="locationInfo" type="text" id="createLocationInfo" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Coordinate Precision Level</div>
                                        <select class="form-select" name="coordinatePrecisionLevel" id="createCoordinatePrecisionLevel">
                                            <option value="0">Tam/Hassas Koordinat</option>
                                            <option value="1">UTM Koordinatı</option>
                                            <option value="2">İlçe Koordinatı</option>
                                            <option value="3">Kare Koordinatı</option>
                                            <option value="4">İl Koordinatı</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--end::Location Card-->
                    <!--begin::Observation Card-->
                    <div class="card shadow-sm modal-section">
                        <div class="card-header">
                            <h3 class="card-title align-items-start flex-column">
                                <span class="card-label fw-bold text-dark">Observation Details</span>
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="row g-5 g-xl-8">
                                <div class="col-xl-6">
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Observer</div>
                                        <input class="form-control" name="observerFullName" type="text" id="createObserverName" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Date</div>
                                        <input class="form-control" name="observationDate" type="date" id="createObservationDate" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Number Seen</div>
                                        <input class="form-control" name="numberSeen" type="number" id="createNumberSeen" />
                                    </div>
                                </div>
                                <div class="col-xl-6">
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Sex</div>
                                        <input class="form-control" name="sex" type="text" id="createSex" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Life Stage</div>
                                        <input class="form-control" name="lifeStage" type="text" id="createLifeStage" />
                                    </div>
                                    <div class="field-container mb-5">
                                        <div class="fs-6 fw-semibold mb-2">Notes</div>
                                        <input class="form-control" name="notes" type="text" id="createNotes" />
                                    </div>
                                </div>
                            </div>
                            <div class="field-container mb-5">
                                <div class="fs-6 fw-semibold mb-2">Source</div>
                                <input class="form-control" name="source" type="text" id="createSource" />
                            </div>
                            <div class="text-center mt-15">
                                <button type="button" class="btn btn-light-success" id="createObservationButton">
                                    <span class="indicator-label">Create</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <!--end::Observation Card-->
                </form>
            </div>
        </div>
    </div>
</div>
<!--end::CreateModal-->
@section Scripts {
    <script>
        // Debounce fonksiyonu
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // DataTable başlatma
        var table = $('#observationTable').DataTable({
            "searching": false,
            "paging": false,
            "info": false,
            "ordering": true,
            "order": [[0, "asc"]]
        });

        // Server-side search implementasyonu
        $(document).ready(function() {
            const searchInput = $('#searchInput');

            // View Details butonu için event listener
            $(document).on('click', '.view-details', function() {
                const observation = JSON.parse($(this).attr('data-observation'));
                showDetails(observation);
            });

            // Debounce ile search işlemi
            const debouncedSearch = debounce(function(value) {
                if (value.trim().length === 0) {
                    window.location.href = '/Observation/Index';
                } else {
                    window.location.href = `/Observation/Index?searchTerm=${encodeURIComponent(value.trim())}&pageNumber=1&pageSize=25`;
                }
            }, 500);

            // Search input event handler
            searchInput.off('keyup').on('keyup', function() {
                debouncedSearch(this.value);
            });

            // URL'den search term'i al ve input'a yerleştir
            const urlParams = new URLSearchParams(window.location.search);
            const searchTerm = urlParams.get('searchTerm');
            if (searchTerm) {
                searchInput.val(decodeURIComponent(searchTerm));
            }
        });

        function loadPage(pageNumber) {
            const searchTerm = $('#searchInput').val().trim();
            const baseUrl = '/Observation/Index';
            const queryParams = new URLSearchParams(window.location.search);

            // Update or add pageNumber
            queryParams.set('pageNumber', pageNumber);

            // Update or add pageSize if it exists in current URL
            if (!queryParams.has('pageSize')) {
                queryParams.set('pageSize', '25'); // Default page size
            }

            // Update or add searchTerm if it exists
            if (searchTerm) {
                queryParams.set('searchTerm', searchTerm);
            } else {
                queryParams.delete('searchTerm');
            }

            window.location.href = `${baseUrl}?${queryParams.toString()}`;
        }

        // Show Details Modal
        function showDetails(observation) {
            try {
                const modal = document.getElementById('kt_modal_observation');

                // Helper function with null check
                const setValue = (elementId, value, suffix = '') => {
                    const element = modal.querySelector('#' + elementId);
                    if (element) {
                        element.textContent = value ? value + suffix : '-';
                    }
                };

                // Classification Info
                setValue('modalScientificName', observation.scientificName);
                setValue('modalFamilyName', observation.familyName);
                setValue('modalGenusName', observation.genusName);
                setValue('modalTurkishName', observation.turkishName);
                setValue('modalEnglishName', observation.englishName);
                setValue('modalAuthority', `${observation.authorityName || ''} ${observation.year ? ', ' + observation.year : ''}`);
                setValue('modalName', observation.name);
                setValue('modalEuName', observation.euName);
                setValue('modalFullName', observation.fullName);
                setValue('modalTurkishNamesTrakel', observation.turkishNamesTrakel);
                setValue('modalTrakel', observation.trakel);

                // Location Info
                setValue('modalProvince', observation.provinceName);
                setValue('modalSquareRef', observation.squareRef);

                // Coordinates display
                const coordinates = [];
                if (observation.squareLatitude) coordinates.push(`Square Latitude: ${observation.squareLatitude}`);
                if (observation.squareLongitude) coordinates.push(`Square Longitude: ${observation.squareLongitude}`);
                if (observation.latitude) coordinates.push(`Latitude: ${observation.latitude}`);
                if (observation.longitude) coordinates.push(`Longitude: ${observation.longitude}`);
                if (observation.decimalDegrees) coordinates.push(`Decimal Degrees: ${observation.decimalDegrees}`);
                if (observation.degreesMinutesSeconds) coordinates.push(`DMS: ${observation.degreesMinutesSeconds}`);
                if (observation.decimalMinutes) coordinates.push(`Decimal Minutes: ${observation.decimalMinutes}`);
                if (observation.utmCoordinates) coordinates.push(`UTM: ${observation.utmCoordinates}`);
                if (observation.mgrsCoordinates) coordinates.push(`MGRS: ${observation.mgrsCoordinates}`);

                setValue('modalCoordinates', coordinates.join('\n'));

                // Altitude
                let altitudeText = '';
                if (observation.altitude1 || observation.altitude2) {
                    if (observation.altitude1) altitudeText += observation.altitude1;
                    if (observation.altitude2) altitudeText += ` - ${observation.altitude2}`;
                    altitudeText += ' metre';
                }
                setValue('modalAltitude', altitudeText);

                setValue('modalUtmReference', observation.utmReference);
                setValue('modalLocationInfo', observation.locationInfo);
                setValue('modalCoordinatePrecisionLevel', getCoordinatePrecisionLevelName(observation.coordinatePrecisionLevel));

                // Observation Details
                setValue('modalObserver', observation.observerFullName);
                setValue('modalObservationDate', observation.observationDate ? new Date(observation.observationDate).toLocaleDateString('tr-TR') : null);
                setValue('modalNumberSeen', observation.numberSeen);
                setValue('modalSex', observation.sex);
                setValue('modalLifeStage', observation.lifeStage);
                setValue('modalNotes', observation.notes);
                setValue('modalSource', observation.source);

                // Show modal
                var myModal = new bootstrap.Modal(modal);
                myModal.show();

            } catch (error) {
                console.error('Error in showDetails:', error);
                Swal.fire({
                    title: 'Hata!',
                    text: 'Detaylar gösterilirken bir hata oluştu.',
                    icon: 'error'
                });
            }
        }

        // CoordinatePrecisionLevel mapping
        function getCoordinatePrecisionLevelName(level) {
            const precisionLevels = {
                0: "Tam/Hassas Koordinat",
                1: "UTM Koordinatı",
                2: "İlçe Koordinatı",
                3: "Kare Koordinatı",
                4: "İl Koordinatı"
            };

            return precisionLevels[level] || "Bilgi yok";
        }
    </script>
    <script>
        function confirmDelete(id) {
            Swal.fire({
                title: 'Emin misiniz?',
                text: "Bu Gözlem kalıcı olarak silinecektir!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Evet, sil!',
                cancelButtonText: 'İptal'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: `${apiConfig.baseUrl}/Observations/${id}`,
                        type: 'DELETE',
                        success: function(response) {
                            Swal.fire({
                                title: 'Silindi!',
                                text: 'Gözlem başarıyla silindi.',
                                icon: 'success',
                                timer: 2000,
                                showConfirmButton: true
                            }).then(() => {
                                window.location.reload();
                            });
                        },
                        error: function(xhr, status, error) {
                            Swal.fire({
                                title: 'Hata!',
                                text: 'Silme işlemi sırasında bir hata oluştu.',
                                icon: 'error'
                            });
                        }
                    });
                }
            });
        }
    </script>
    <script>
        async function populateProvinceDropdown(selectElement, selectedProvinceId) {
            try {
                const response = await fetch(`https://localhost:7128/api/Provinces`);
                if (!response.ok) {
                    throw new Error('Failed to fetch provinces');
                }

                const result = await response.json();
                const provinces = result.data;

                // Clear existing options except the first one
                selectElement.innerHTML = '<option value="">Select Province</option>';

                // Sort provinces by name
                provinces.sort((a, b) => a.name.localeCompare(b.name));

                // Add provinces to dropdown
                provinces.forEach(province => {
                    const option = document.createElement('option');
                    option.value = province.provinceCode;
                    option.textContent = province.name.trim(); // Trim to remove any whitespace
                    selectElement.appendChild(option);
                });

                // Set selected province if provided
                if (selectedProvinceId) {
                    selectElement.value = selectedProvinceId;
                }
            } catch (error) {
                console.error('Error loading provinces:', error);
                // Show error message to user
                Swal.fire({
                    text: 'Error loading provinces: ' + error.message,
                    icon: 'error',
                    buttonsStyling: false,
                    confirmButtonText: 'OK',
                    customClass: {
                        confirmButton: 'btn btn-primary'
                    }
                });
            }
        }

        async function updateObservation(id) {
            try {

                const observationResponse = await fetch(`https://localhost:7128/api/Observations/${id}`);
                if (!observationResponse.ok) {
                    throw new Error('Verileri alınırken bir hata oluştu.');
                }
                const item = await observationResponse.json();
                const modalElement = document.getElementById('kt_updatemodal_observation');
                const modal = new bootstrap.Modal(modalElement);

                modal.show();

                // Classification bilgileri
                document.getElementById('updateId').value = item.data.id || '';
                document.getElementById('updateScientificName').value = item.data.scientificName || '';
                document.getElementById('updateFamilyName').value = item.data.familyName || '';
                document.getElementById('updateGenusName').value = item.data.genusName || '';
                document.getElementById('updateEUName').value = item.data.euName || '';
                document.getElementById('updateFullName').value = item.data.fullName || '';
                document.getElementById('updateTurkishName').value = item.data.turkishName || '';
                document.getElementById('updateEnglishName').value = item.data.englishName || '';
                document.getElementById('updateAuthority').value = item.data.authorityName && item.data.year ? `${item.data.authorityName},${item.data.year}` : '';
                document.getElementById('updateName').value = item.data.name || '';
                document.getElementById('updateTurkishNamesTrakel').value = item.data.turkishNamesTrakel || '';
                document.getElementById('updateTrakel').value = item.data.trakel || '';
                document.getElementById('updateKocakName').value = item.data.kocakName || '';
                document.getElementById('updateHesselbarthName').value = item.data.hesselbarthName || '';

                // Location bilgileri - Province ID'yi seç
                const provinceSelect = document.getElementById('updateProvinceName');
                await populateProvinceDropdown(provinceSelect, item.data.provinceId);
                document.getElementById('updateSquareRef').value = item.data.squareRef || '';
                document.getElementById('updateSquareLatitude').value = item.data.squareLatitude || '';
                document.getElementById('updateSquareLongitude').value = item.data.squareLongitude || '';
                document.getElementById('updateAltitude1').value = item.data.altitude1 || '';
                document.getElementById('updateAltitude2').value = item.data.altitude2 || '';
                document.getElementById('updateUtmReference').value = item.data.utmReference || '';
                document.getElementById('updateLocationInfo').value = item.data.locationInfo || '';
                document.getElementById('updateDecimalDegrees').value = item.data.decimalDegrees || '';
                document.getElementById('updateDegreesMinutesSeconds').value = item.data.degreesMinutesSeconds || '';
                document.getElementById('updateDecimalMinutes').value = item.data.decimalMinutes || '';
                document.getElementById('updateUtmCoordinates').value = item.data.utmCoordinates || '';
                document.getElementById('updateMgrsCoordinates').value = item.data.mgrsCoordinates || '';
                // CoordinatePrecisionLevel için özel kontrol ekleyelim
                const precisionLevelSelect = document.getElementById('updateCoordinatePrecisionLevel');
                const precisionLevel = item.data.coordinatePrecisionLevel;
                console.log('CoordinatePrecisionLevel from API:', precisionLevel); // Debug log

                if (precisionLevelSelect) {
                    precisionLevelSelect.value = precisionLevel !== null && precisionLevel !== undefined ? precisionLevel.toString() : '0';
                    console.log('Set precision level to:', precisionLevelSelect.value); // Debug log
                }
                document.getElementById('updateLatitude').value = item.data.latitude || '';
                document.getElementById('updateLongitude').value = item.data.longitude || '';

                // Observation bilgileri
                document.getElementById('updateObserverName').value = item.data.observerFullName || '';
                document.getElementById('updateObservationDate').value = item.data.observationDate ? item.data.observationDate.split('T')[0] : '';
                document.getElementById('updateNumberSeen').value = item.data.numberSeen || '';
                document.getElementById('updateSex').value = item.data.sex || '';
                document.getElementById('updateLifeStage').value = item.data.lifeStage || '';
                document.getElementById('updateNotes').value = item.data.notes || '';
                document.getElementById('updateSource').value = item.data.source || '';

            } catch (error) {
                console.error('Hata:', error);
                Swal.fire({
                    text: 'Veriler alınırken bir hata oluştu: ' + error.message,
                    icon: 'error',
                    buttonsStyling: false,
                    confirmButtonText: 'Tamam',
                    customClass: {
                        confirmButton: 'btn btn-primary'
                    }
                });
            }
        }
    </script>
    <script>
        $(document).ready(function() {
            $('#updateObservationButton').on('click', function() {
                 // Form verilerini obje olarak toplama
            const authorityValue = $('#updateAuthority').val();
            let authorityName = '';
            let year = 0;
            if (authorityValue) {
                const parts = authorityValue.split(',').map(part => part.trim());
                if (parts.length === 2) {
                    authorityName = parts[0];
                    year = parseInt(parts[1]) || 0;
                }
            }
            const observerValue=$('#updateObserverName').val();
            let observerName='';
            let surname='';
            if(observerValue){
                const parts=observerValue.split(' ').map(part=>part.trim());
                if(parts.length===2){
                    observerName=parts[0];
                    surname=parts[1];
                }
            }
            const formData = {
                // Hidden ID
                id: $('#updateId').val(),
                
                // Classification bilgileri
                scientificName: $('#updateScientificName').val(),
                familyName: $('#updateFamilyName').val(),
                genusName: $('#updateGenusName').val(),
                euName: $('#updateEUName').val(),
                fullName: $('#updateFullName').val(),
                turkishName: $('#updateTurkishName').val(),
                englishName: $('#updateEnglishName').val(),
                authorityName: $('#updateAuthority').val(),
                name: $('#updateName').val(),
                turkishNamesTrakel: $('#updateTurkishNamesTrakel').val(),
                trakel: $('#updateTrakel').val(),
                kocakName: $('#updateKocakName').val(),
                hesselbarthName: $('#updateHesselbarthName').val(),
                authorityName: authorityName,
                year: year,

                provinceId: parseInt($('#updateProvinceName').val()) || 0,
                squareRef: $('#updateSquareRef').val(),
                squareLatitude: parseFloat($('#updateSquareLatitude').val()) || 0,
                squareLongitude: parseFloat($('#updateSquareLongitude').val()) || 0,
                latitude: parseFloat($('#updateLatitude').val()) || 0,
                longitude: parseFloat($('#updateLongitude').val()) || 0,
                decimalDegrees: $('#updateDecimalDegrees').val(),
                degreesMinutesSeconds: $('#updateDegreesMinutesSeconds').val(),
                decimalMinutes: $('#updateDecimalMinutes').val(),
                utmCoordinates: $('#updateUtmCoordinates').val(),
                mgrsCoordinates: $('#updateMgrsCoordinates').val(),
                altitude1: parseFloat($('#updateAltitude1').val()) || 0,
                altitude2: parseFloat($('#updateAltitude2').val()) || 0,
                utmReference: $('#updateUtmReference').val(),
                locationInfo: $('#updateLocationInfo').val(),
                coordinatePrecisionLevel: parseInt($('#updateCoordinatePrecisionLevel').val()) || 0,

                // Observation bilgileri
                observerFullName: $('#updateObserverName').val(),
                observerName: observerName,
                surname: surname,
                observationDate: $('#updateObservationDate').val(),
                numberSeen: parseInt($('#updateNumberSeen').val()) || 0,
                sex: $('#updateSex').val(),
                lifeStage: $('#updateLifeStage').val(),
                notes: $('#updateNotes').val(),
                source: $('#updateSource').val()
            };

                console.log('Gönderilen veriler:', formData); // Kontrol için
                $.ajax({
                    url: `https://localhost:7128/api/Observations`,
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function(response) {
                        Swal.fire({
                            title: 'Başarılı!',
                            text: 'Gözlem başarıyla güncellendi.',
                            icon: 'success',
                            timer: 2000,
                            showConfirmButton: true
                        }).then(() => {
                            window.location.reload();
                        });
                    },
                    error: function(xhr, status, error) {
                        Swal.fire({
                            title: 'Hata!',
                            text: 'Güncelleme işlemi sırasında bir hata oluştu.',
                            icon: 'error'
                        });
                    }
                });
            });
        });
    </script>
    <script>
        async function populateProvinceDropdown2(selectElementId) {
            try 
            {
                const result = await $.ajax({
                    url: `https://localhost:7128/api/Provinces`,
                    type: 'GET',
                    contentType: 'application/json'
                });

                if (!result.isSuccess) {
                    throw new Error('Failed to fetch provinces');
                }

                const selectElement = document.getElementById(selectElementId);
                selectElement.innerHTML = '<option value="">Select Province</option>';

                const sortedProvinces = result.data.sort((a, b) => {
                    return a.name.localeCompare(b.name, 'tr-TR');
                });

                sortedProvinces.forEach(province => {
                    const option = document.createElement('option');
                    option.value = province.id;
                    option.textContent = province.name.trim();
                    selectElement.appendChild(option);
                });

            } 
            catch (error) {
                console.error('Error loading provinces:', error);
                Swal.fire({
                    title: 'Error!',
                    text: 'Failed to load provinces: ' + error.message,
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        }

        document.getElementById('kt_createmodal_observation').addEventListener('show.bs.modal', function () {
            populateProvinceDropdown2('createProvinceName');
        });

        $(document).ready(function() {
            // Zorunlu alanları işaretle
            const requiredFields = [
                'createSquareRef',
                'createLatitude',
                'createLongitude',
                'createProvinceName',
                'createName',
                'createScientificName',
                'createObserverName',
                'createObservationDate',
                'createNumberSeen'
            ];

            // Zorunlu alan işaretlerini ekle
            requiredFields.forEach(fieldId => {
                const label = $(`#${fieldId}`).prev('.fs-6.fw-semibold');
                label.html(`${label.html()} <span class="text-danger">*</span>`);
                $(`#${fieldId}`).prop('required', true);
            });

            $('#createObservationButton').on('click', function(e) {
                // Validasyon kontrolü
                let isValid = true;
                let firstInvalidField = null;

                // Zorunlu alanları kontrol et
                requiredFields.forEach(fieldId => {
                    const field = $(`#${fieldId}`);
                    const value = field.val();

                    if (!value || value.trim() === '') {
                        isValid = false;
                        field.addClass('is-invalid');
                        if (!firstInvalidField) firstInvalidField = field;

                        if (field.next('.invalid-feedback').length === 0) {
                            field.after(`<div class="invalid-feedback">This field is required</div>`);
                        }
                    } else {
                        field.removeClass('is-invalid');
                        field.next('.invalid-feedback').remove();
                    }
                });

                // Koordinat validasyonu
                const latitude = parseFloat($('#createLatitude').val());
                const longitude = parseFloat($('#createLongitude').val());

                if (isNaN(latitude) || latitude < -90 || latitude > 90) {
                    isValid = false;
                    $('#createLatitude').addClass('is-invalid');
                    if ($('#createLatitude').next('.invalid-feedback').length === 0) {
                        $('#createLatitude').after('<div class="invalid-feedback">Please enter a valid latitude (-90 to 90)</div>');
                    }
                    if (!firstInvalidField) firstInvalidField = $('#createLatitude');
                }

                if (isNaN(longitude) || longitude < -180 || longitude > 180) {
                    isValid = false;
                    $('#createLongitude').addClass('is-invalid');
                    if ($('#createLongitude').next('.invalid-feedback').length === 0) {
                        $('#createLongitude').after('<div class="invalid-feedback">Please enter a valid longitude (-180 to 180)</div>');
                    }
                    if (!firstInvalidField) firstInvalidField = $('#createLongitude');
                }

                // Authority formatı kontrolü
                const authorityValue = $('#createAuthority').val();
                if (authorityValue && !authorityValue.match(/^.+,\s*\d+$/)) {
                    isValid = false;
                    $('#createAuthority').addClass('is-invalid');
                    if ($('#createAuthority').next('.invalid-feedback').length === 0) {
                        $('#createAuthority').after('<div class="invalid-feedback">Authority must be in format "Name, Year"</div>');
                    }
                    if (!firstInvalidField) firstInvalidField = $('#createAuthority');
                }

                // Observer name surname kontrolü
                const observerValue = $('#createObserverName').val();
                if (observerValue) {
                    const nameParts = observerValue.trim().split(/\s+/);
                    if (nameParts.length < 2) {
                        isValid = false;
                        $('#createObserverName').addClass('is-invalid');
                        if ($('#createObserverName').next('.invalid-feedback').length === 0) {
                            $('#createObserverName').after('<div class="invalid-feedback">Observer must include both name and surname</div>');
                        }
                        if (!firstInvalidField) firstInvalidField = $('#createObserverName');
                    }
                }

                // NumberSeen kontrolü
                const numberSeen = parseInt($('#createNumberSeen').val());
                if (isNaN(numberSeen) || numberSeen <= 0) {
                    isValid = false;
                    $('#createNumberSeen').addClass('is-invalid');
                    if ($('#createNumberSeen').next('.invalid-feedback').length === 0) {
                        $('#createNumberSeen').after('<div class="invalid-feedback">Please enter a valid positive number</div>');
                    }
                    if (!firstInvalidField) firstInvalidField = $('#createNumberSeen');
                }

                if (!isValid) {
                    e.preventDefault();
                    if (firstInvalidField) {
                        firstInvalidField[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                        firstInvalidField.focus();
                    }

                    Swal.fire({
                        title: 'Validation Error!',
                        text: 'Please fill in all required fields correctly',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                    return false;
                }

                // Authority parsing
                let authorityName = '';
                let year = 0;
                if (authorityValue) {
                    const parts = authorityValue.split(/,(?=[^,]+$)/).map(part => part.trim());
                    if (parts.length === 2) {
                        authorityName = parts[0];
                        year = parseInt(parts[1]) || 0;
                    }
                }

                // Observer parsing
                let observerName = '';
                let surname = '';
                if (observerValue) {
                    const parts = observerValue.split(' ').map(part => part.trim()).filter(part => part);
                    if (parts.length >= 2) {
                        surname = parts[parts.length - 1];
                        observerName = parts.slice(0, -1).join(' ');
                    }
                }

                // Form data hazırlama
                const formData = {
                    // Classification bilgileri
                    scientificName: $('#createScientificName').val() || null,
                    familyName: $('#createFamilyName').val() || null,
                    genusName: $('#createGenusName').val() || null,
                    euName: $('#createEUName').val() || null,
                    fullName: $('#createFullName').val() || null,
                    turkishName: $('#createTurkishName').val() || null,
                    englishName: $('#createEnglishName').val() || null,
                    name: $('#createName').val() || null,
                    turkishNamesTrakel: $('#createTurkishNamesTrakel').val() || null,
                    trakel: $('#createTrakel').val() || null,
                    kocakName: $('#createKocakName').val() || null,
                    hesselbarthName: $('#createHesselbarthName').val() || null,
                    authorityName: authorityName || null,
                    year: year || 0,

                    // Location bilgileri
                    provinceId: $('#createProvinceName').val() ? parseInt($('#createProvinceName').val()) : 0,
                    squareRef: $('#createSquareRef').val() || null,
                    squareLatitude: $('#createSquareLatitude').val() ? parseFloat($('#createSquareLatitude').val()) : 0,
                    squareLongitude: $('#createSquareLongitude').val() ? parseFloat($('#createSquareLongitude').val()) : 0,
                    latitude: $('#createLatitude').val() ? parseFloat($('#createLatitude').val()) : 0,
                    longitude: $('#createLongitude').val() ? parseFloat($('#createLongitude').val()) : 0,
                    decimalDegrees: $('#createDecimalDegrees').val() || null,
                    degreesMinutesSeconds: $('#createDegreesMinutesSeconds').val() || null,
                    decimalMinutes: $('#createDecimalMinutes').val() || null,
                    utmCoordinates: $('#createUtmCoordinates').val() || null,
                    mgrsCoordinates: $('#createMgrsCoordinates').val() || null,
                    altitude1: $('#createAltitude1').val() ? parseFloat($('#createAltitude1').val()) : 0,
                    altitude2: $('#createAltitude2').val() ? parseFloat($('#createAltitude2').val()) : 0,
                    utmReference: $('#createUtmReference').val() || null,
                    locationInfo: $('#createLocationInfo').val() || null,
                    coordinatePrecisionLevel: $('#createCoordinatePrecisionLevel').val() ? parseInt($('#createCoordinatePrecisionLevel').val()) : 0,

                    // Observation bilgileri
                    observerFullName: observerValue || null,
                    observerName: observerName || null,
                    surname: surname || null,
                    observationDate: $('#createObservationDate').val() || null,
                    numberSeen: $('#createNumberSeen').val() ? parseInt($('#createNumberSeen').val()) : 0,
                    sex: $('#createSex').val() || null,
                    lifeStage: $('#createLifeStage').val() || null,
                    notes: $('#createNotes').val() || null,
                    source: $('#createSource').val() || null
                };

                // AJAX isteği
                $.ajax({
                    url: `https://localhost:7128/api/Observations`,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function(response) {
                        if (response.isSuccess) {
                            Swal.fire({
                                title: 'Success!',
                                text: 'Observation created successfully',
                                icon: 'success',
                                timer: 2000,
                                showConfirmButton: true
                            }).then(() => {
                                $('#kt_createmodal_observation').modal('hide');
                                window.location.reload();
                            });
                        } else {
                            Swal.fire({
                                title: 'Error!',
                                text: response.errorList ? response.errorList.join(', ') : 'Failed to create observation',
                                icon: 'error'
                            });
                        }
                    },
                    error: function(xhr, status, error) {
                        let errorMessage = 'Failed to create observation';
                        if (xhr.responseJSON && xhr.responseJSON.errorList) {
                            errorMessage = xhr.responseJSON.errorList.join(', ');
                        }
                        Swal.fire({
                            title: 'Error!',
                            text: errorMessage,
                            icon: 'error'
                        });
                    }
                });
            });

            // Input değişikliklerinde validasyon mesajlarını temizle
            $('input, select').on('input change', function() {
                $(this).removeClass('is-invalid');
                $(this).next('.invalid-feedback').remove();
            });

            // Modal kapandığında formu ve validasyon mesajlarını temizle
            $('#kt_createmodal_observation').on('hidden.bs.modal', function () {
                $('#create_observation_form')[0].reset();
                $('.is-invalid').removeClass('is-invalid');
                $('.invalid-feedback').remove();
            });
        });
    </script>
    <script>
        const apiConfig = {
            baseUrl: '@Configuration["ApiSettings:BaseUrl"]'
        };
    </script>
}
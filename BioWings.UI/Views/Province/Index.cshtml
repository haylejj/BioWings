@model ApiPaginatedListResult<ObservationGetViewModel>
@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/MainLayout/Index.cshtml";
}


<div class="card shadow-sm">
    <div class="card-header border-0 py-5">
        <div class="card-title">
            <h2 class="fw-bold">Observations</h2>
        </div>
        <div class="card-toolbar d-flex gap-2 align-items-center">
            <!-- Export Button -->
            <button onclick="exportObservationsByProvince()" class="btn btn-primary">
                <i class="fas fa-file-excel me-2"></i>
                Export to Excel
            </button>

            <!-- Search Controls -->
            <div class="d-flex gap-3 align-items-center">
                <select class="form-select form-select-solid w-200px" id="provinceSelect">
                    <option value="">Select Province</option>
                </select>
                <button type="button" class="btn btn-primary px-4" id="searchButton">
                    <i class="fas fa-search me-2"></i>
                    Get Observations
                </button>
            </div>
        </div>
    </div>

    <div class="card-body py-3">
        <!-- Table Container -->
        <div class="table-responsive">
            <table class="table table-row-dashed table-row-gray-300 align-middle gs-0 gy-4" id="observationTable">
                <!-- Table Header -->
                <thead>
                    <tr class="fw-bold text-muted bg-light">
                        <th class="min-w-150px">Species Name</th>
                        <th class="min-w-150px">Scientific Name</th>
                        <th class="min-w-120px">Family</th>
                        <th class="min-w-120px">Genus</th>
                        <th class="min-w-120px">Authority</th>
                        <th class="min-w-150px">Latitude,Longitude</th>
                        <th class="min-w-120px">Observation Date</th>
                        <th class="min-w-100px text-center">Number Seen</th>
                        <th class="min-w-100px text-end">Actions</th>
                    </tr>
                </thead>
                <!-- Table Body -->
                <tbody class="text-gray-600 fw-semibold">
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="d-flex flex-stack flex-wrap pt-10">
            <div class="fs-6 fw-semibold text-gray-700" id="paginationInfo"></div>
            <ul class="pagination" id="pagination"></ul>
        </div>
    </div>
</div>

<!--Detail Modal-->
<div class="modal fade" id="kt_modal_detailobservation" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content rounded">
            <div class="modal-header pb-0 border-0 justify-content-end">
                <div class="btn btn-sm btn-icon btn-active-color-primary" data-bs-dismiss="modal">
                    <i class="ki-duotone ki-cross fs-1">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </div>
            </div>

            <div class="modal-body scroll-y px-10 px-lg-15 pt-0 pb-15">
                <div class="mb-13 text-center">
                    <h1 class="mb-3">Observation Details</h1>
                </div>

                <!--begin::Classification Card-->
                <div class="card shadow-sm mb-8 modal-section">
                    <div class="card-header">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold text-dark">Classification Information</span>
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-5 g-xl-8">
                            <div class="col-xl-6">
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Scientific Name</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalScientificName"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Family Name</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalFamilyName"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Genus Name</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalGenusName"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">EU Name</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalEuName"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Full Name</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalFullName"></div>
                                </div>
                            </div>
                            <div class="col-xl-6">
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Turkish Name</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalTurkishName"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">English Name</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalEnglishName"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Authority</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalAuthority"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Species Name</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalName"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Turkish Names Trakel</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalTurkishNamesTrakel"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Trakel</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalTrakel"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--end::Classification Card-->
                <!--begin::Location Card-->
                <div class="card shadow-sm mb-8 modal-section">
                    <div class="card-header">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold text-dark">Location Details</span>
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-5 g-xl-8">
                            <div class="col-xl-6">
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Province</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalProvince"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Coordinates</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalCoordinates"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Square Reference</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalSquareRef"></div>
                                </div>
                            </div>
                            <div class="col-xl-6">
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Altitude</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalAltitude"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">UTM Reference</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalUtmReference"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Location Info</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalLocationInfo"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Coordinate Precision Level</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalCoordinatePrecisionLevel"></div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
                <!--end::Location Card-->
                <!--begin::Observation Card-->
                <div class="card shadow-sm modal-section">
                    <div class="card-header">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold text-dark">Observation Details</span>
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-5 g-xl-8">
                            <div class="col-xl-6">
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Observer</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalObserver"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Date</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalObservationDate"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Number Seen</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalNumberSeen"></div>
                                </div>
                            </div>
                            <div class="col-xl-6">
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Sex</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalSex"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Life Stage</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalLifeStage"></div>
                                </div>
                                <div class="field-container mb-5">
                                    <div class="fs-6 fw-semibold mb-2">Notes</div>
                                    <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalNotes"></div>
                                </div>
                            </div>
                        </div>
                        <div class="field-container mb-5">
                            <div class="fs-6 fw-semibold mb-2">Source</div>
                            <div class="fs-7 text-gray-800 bg-light p-3 rounded" id="modalSource"></div>
                        </div>
                    </div>
                </div>
                <!--end::Observation Card-->
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        let currentPage = 1;
        const pageSize = 25;

        $(document).ready(function() {
            loadProvinces();
            setupEventHandlers();
        });

        async function loadProvinces() {
            try {
                const response = await fetch('https://localhost:7128/api/Provinces');
                const result = await response.json();

                if (result.isSuccess) {
                    const provinces = result.data.sort((a, b) => a.name.localeCompare(b.name));
                    const select = $('#provinceSelect');

                    provinces.forEach(province => {
                        select.append(new Option(province.name, province.provinceCode));
                    });
                }
            } catch (error) {
                console.error('Error loading provinces:', error);
                showError('Failed to load provinces');
            }
        }

        function setupEventHandlers() {
            $('#searchButton').click(() => {
                currentPage = 1;
                loadObservations();
            });


            $('#provinceSelect').on('keypress', function(e) {
                if (e.which === 13) {
                    currentPage = 1;
                    loadObservations();
                }
            });
        }

        function displayObservations(data) {
            const tbody = $('#observationTable tbody');
            tbody.empty();

            if (data.items && data.items.length > 0) 
            {
                data.items.forEach(obs => {
                    tbody.append(`
                        <tr>
                            <td>${obs.speciesName || '-'}</td>
                            <td>${obs.scientificName || '-'}</td>
                            <td>${obs.familyName || '-'}</td>
                            <td>${obs.genusName || '-'}</td>
                            <td>${obs.authorityName || '-'}${obs.authorityYear ? `, ${obs.authorityYear}` : ''}</td>
                            <td>${obs.latitude ? `${obs.latitude}, ${obs.longitude}` : '-'}</td>
                            <td>${new Date(obs.observationDate).toLocaleDateString('tr-TR')}</td>
                            <td>${obs.numberSeen}</td>
                            <td>
                                <button class="btn btn-sm btn-light-primary" onclick="showDetails(${obs.id})">
                                    Details
                                </button>
                            </td>
                        </tr>
                    `);
                });
                updatePagination(data);
            } 
            else 
            {
                tbody.append(`
                    <tr>
                        <td colspan="8" class="text-center">No observations found</td>
                    </tr>
                `);
            }
        }

        function updatePagination(data) {
            const paginationInfo = $('#paginationInfo');
            const pagination = $('#pagination');

            paginationInfo.empty();
            pagination.empty();

            if (!data.items || data.items.length === 0) return;

            const totalPages = Math.ceil(data.totalCount / data.pageSize);
            if (totalPages <= 1) return;

            paginationInfo.html(`
                Showing ${(data.pageNumber - 1) * data.pageSize + 1} to ${Math.min(data.pageNumber * data.pageSize, data.totalCount)} of ${data.totalCount} entries
            `);

            let startPage = Math.max(1, data.pageNumber - 2);
            let endPage = Math.min(totalPages, startPage + 4);

            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }

            pagination.append(`
                <li class="page-item previous ${data.pageNumber === 1 ? 'disabled' : ''}">
                    <a href="javascript:;" onclick="changePage(${data.pageNumber - 1})" class="page-link">
                        <i class="previous"></i>
                    </a>
                </li>
            `);

            if (startPage > 1) {
                pagination.append(`
                    <li class="page-item">
                        <a href="javascript:;" onclick="changePage(1)" class="page-link">1</a>
                    </li>
                `);
                if (startPage > 2) {
                    pagination.append(`
                        <li class="page-item">
                            <span class="page-link">...</span>
                        </li>
                    `);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                pagination.append(`
                    <li class="page-item ${i === data.pageNumber ? 'active' : ''}">
                        <a href="javascript:;" onclick="changePage(${i})" class="page-link">${i}</a>
                    </li>
                `);
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    pagination.append(`
                        <li class="page-item">
                            <span class="page-link">...</span>
                        </li>
                    `);
                }
                pagination.append(`
                    <li class="page-item">
                        <a href="javascript:;" onclick="changePage(${totalPages})" class="page-link">${totalPages}</a>
                    </li>
                `);
            }

            pagination.append(`
                <li class="page-item next ${data.pageNumber === totalPages ? 'disabled' : ''}">
                    <a href="javascript:;" onclick="changePage(${data.pageNumber + 1})" class="page-link">
                        <i class="next"></i>
                    </a>
                </li>
            `);
        }

        function changePage(page) {
            if (page < 1) return;

            const provinceCode = $('#provinceSelect').val();
            if (!provinceCode) return;

            currentPage = page;
            loadObservations(); 
        }

        async function loadObservations() {
            const provinceCode = $('#provinceSelect').val();

            if (!provinceCode) {
                showError('Please select a province');
                return;
            }

            try {
                const response = await fetch(`https://localhost:7128/api/Observations/ByProvince/${provinceCode}?pageNumber=${currentPage}&pageSize=25`);
                const result = await response.json();

                if (result.isSuccess) {
                    displayObservations(result.data);
                } else {
                    showError(result.errorList?.join(', ') || 'Failed to load observations');
                }
            } catch (error) {
                console.error('Error loading observations:', error);
                showError('Failed to load observations');
            }
        }

        function showError(message) {
            Swal.fire({
                text: message,
                icon: 'error',
                buttonsStyling: false,
                confirmButtonText: 'OK',
                customClass: {
                    confirmButton: 'btn btn-primary'
                }
            });
        }
    </script>
    <script>
                async function showDetails(id) {
            try {
                const observationResponse = await fetch(`https://localhost:7128/api/Observations/${id}`);
                if (!observationResponse.ok) {
                    throw new Error('Verileri alınırken bir hata oluştu.');
                }
                const item = await observationResponse.json();
                const modalElement = document.getElementById('kt_modal_detailobservation');
                const modal = new bootstrap.Modal(modalElement);

                modal.show();

                // Classification Information
                document.getElementById('modalScientificName').textContent = item.data.scientificName || '';
                document.getElementById('modalFamilyName').textContent = item.data.familyName || '';
                document.getElementById('modalGenusName').textContent = item.data.genusName || '';
                document.getElementById('modalEuName').textContent = item.data.euName || '';
                document.getElementById('modalFullName').textContent = item.data.fullName || '';
                document.getElementById('modalTurkishName').textContent = item.data.turkishName || '';
                document.getElementById('modalEnglishName').textContent = item.data.englishName || '';
                document.getElementById('modalAuthority').textContent = item.data.authorityName && item.data.year ? `${item.data.authorityName}, ${item.data.year}` : '';
                document.getElementById('modalName').textContent = item.data.name || '';
                document.getElementById('modalTurkishNamesTrakel').textContent = item.data.turkishNamesTrakel || '';
                document.getElementById('modalTrakel').textContent = item.data.trakel || '';

                // Location Details
                document.getElementById('modalProvince').textContent = item.data.provinceName || '';
                const coordinates = [];
                if (item.data.squareLatitude) coordinates.push(`Square Latitude: ${item.data.squareLatitude}`);
                if (item.data.squareLongitude) coordinates.push(`Square Longitude: ${item.data.squareLongitude}`);
                if (item.data.latitude) coordinates.push(`Latitude: ${item.data.latitude.toFixed(6)}`);
                if (item.data.longitude) coordinates.push(`Longitude: ${item.data.longitude.toFixed(6)}`);
                if (item.data.decimalDegrees) coordinates.push(`Decimal Degrees: ${item.data.decimalDegrees}`);
                if (item.data.degreesMinutesSeconds) coordinates.push(`DMS: ${item.data.degreesMinutesSeconds}`);
                if (item.data.decimalMinutes) coordinates.push(`Decimal Minutes: ${item.data.decimalMinutes}`);
                if (item.data.utmCoordinates) coordinates.push(`UTM: ${item.data.utmCoordinates}`);
                if (item.data.mgrsCoordinates) coordinates.push(`MGRS: ${item.data.mgrsCoordinates}`);

                document.getElementById('modalCoordinates').textContent = coordinates.join('\n');
                document.getElementById('modalSquareRef').textContent = item.data.squareRef || '';

                let altitudeText = '';
                if (item.data.altitude1) {
                    altitudeText = `${item.data.altitude1}m`;
                    if (item.data.altitude2) {
                        altitudeText += ` - ${item.data.altitude2}m`;
                    }
                }
                document.getElementById('modalAltitude').textContent = altitudeText;
                document.getElementById('modalUtmReference').textContent = item.data.utmReference || '';
                document.getElementById('modalCoordinatePrecisionLevel').textContent = getCoordinatePrecisionLevelName(item.data.coordinatePrecisionLevel);
                document.getElementById('modalLocationInfo').textContent = item.data.locationInfo || '';
                document.getElementById('modalObserver').textContent = item.data.observerFullName || '';
                document.getElementById('modalObservationDate').textContent = item.data.observationDate ? new Date(item.data.observationDate).toLocaleDateString() : '';
                document.getElementById('modalNumberSeen').textContent = item.data.numberSeen || '';
                document.getElementById('modalSex').textContent = item.data.sex || '';
                document.getElementById('modalLifeStage').textContent = item.data.lifeStage || '';
                document.getElementById('modalNotes').textContent = item.data.notes || '';
                document.getElementById('modalSource').textContent = item.data.source || '';
            }
            catch (error) {
                console.error('Hata:', error);
                Swal.fire({
                    text: 'Gözlem verilerini alınırken bir hata oluştu: ' + error.message,
                    icon: 'error',
                    buttonsStyling: false,
                    confirmButtonText: 'Tamam',
                    customClass: {
                        confirmButton: 'btn btn-primary'
                    }
                });
            }
        }

        function getCoordinatePrecisionLevelName(level) {
            const precisionLevels = {
                0: "Tam/Hassas Koordinat",
                1: "UTM Koordinatı",
                2: "İlçe Koordinatı",
                3: "Kare Koordinatı",
                4: "İl Koordinatı"
            };

            return precisionLevels[level] || "Bilgi yok";
        }
    </script>
    <script>
    async function exportObservationsByProvince() {
           const provinceCode = $('#provinceSelect').val();
           if (!provinceCode) {
               Swal.fire({
                   text: 'Please select a province first',
                   icon: 'warning',
                   buttonsStyling: false,
                   confirmButtonText: 'OK',
                   customClass: {
                       confirmButton: 'btn btn-primary'
                   }
               });
               return;
           }
           try {
               Swal.fire({
                   text: 'Export is in progress...',
                   icon: 'info',
                   allowOutsideClick: false,
                   showConfirmButton: false,
                   willOpen: () => {
                       Swal.showLoading();
                   }
               });
               const response = await fetch(`/ExportData/${provinceCode}`, {
                   method: 'GET'
               });

               if (response.status === 404) {
                   Swal.fire({
                       text: 'No data found for selected province',
                       icon: 'info',
                       buttonsStyling: false,
                       confirmButtonText: 'OK',
                       customClass: {
                           confirmButton: 'btn btn-primary'
                       }
                   });
                   return;
               }

               if (!response.ok) {
                   throw new Error('Export failed');
               }

               const blob = await response.blob();

               if (!blob || blob.size === 0) {
                   Swal.fire({
                       text: 'No data available for export',
                       icon: 'info',
                       buttonsStyling: false,
                       confirmButtonText: 'OK',
                       customClass: {
                           confirmButton: 'btn btn-primary'
                       }
                   });
                   return;
               }

               const url = window.URL.createObjectURL(blob);
               const a = document.createElement('a');
               a.href = url;
               a.download = `Observations_${new Date().toISOString().split('T')[0]}.xlsx`;
               document.body.appendChild(a);
               a.click();
               window.URL.revokeObjectURL(url);
               a.remove();

               Swal.close();
               Swal.fire({
                   text: 'Export completed successfully',
                   icon: 'success',
                   buttonsStyling: false,
                   confirmButtonText: 'OK',
                   customClass: {
                       confirmButton: 'btn btn-primary'
                   }
               });
           } catch (error) {
               console.error('Export error:', error);
               Swal.fire({
                   text: 'An error occurred during export',
                   icon: 'error',
                   buttonsStyling: false,
                   confirmButtonText: 'OK',
                   customClass: {
                       confirmButton: 'btn btn-primary'
                   }
               });
           }
        }
    </script>
}
@{
    ViewData["Title"] = "Export";
    Layout = "~/Views/MainLayout/Index.cshtml";
}

<!--begin::Card-->
<!--begin::Card-->
<div class="card">
    <div class="card-header border-0 pt-6">
        <div class="card-title">
            <h2>Export Data</h2>
        </div>
    </div>
    <div class="card-body py-4">
        <div class="row">
            <!-- Selected Columns - Excel Style -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Selected Columns</h3>
                    </div>
                    <div class="card-body">
                        <div id="selectedColumns" class="selected-columns d-flex flex-wrap gap-2 p-3 border rounded min-h-150px">
                            <!-- Seçilen kolonlar buraya yan yana dizilecek -->
                        </div>
                    </div>
                </div>
                <!-- Date and Record Options -->
                <div class="row mt-5">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Observation Date Range</h3>
                            </div>
                            <div class="card-body">
                                <div class="export-checkbox-container">
                                    <div class="form-check form-check-custom form-check-solid">
                                        <input class="form-check-input" type="checkbox" id="exportAllDates">
                                        <label class="form-check-label" for="exportAllDates">
                                            Export All Dates
                                        </label>
                                    </div>
                                </div>
                                <div id="dateInputs">
                                    <div class="mb-5">
                                        <label class="form-label">Start Date</label>
                                        <input type="date" class="form-control mb-3" id="startDate" />
                                        <label class="form-label">End Date</label>
                                        <input type="date" class="form-control" id="endDate" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Record Limit Card -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Record Limit</h3>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info d-flex align-items-center mb-3">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <div>Total number of observations: @ViewBag.observationCount</div>
                                </div>
                                <div class="export-checkbox-container">
                                    <div class="form-check form-check-custom form-check-solid">
                                        <input class="form-check-input" type="checkbox" id="exportAllRecords">
                                        <label class="form-check-label" for="exportAllRecords">
                                            Export All Records
                                        </label>
                                    </div>
                                </div>
                                <div id="limitInputs">
                                    <div class="mb-5">
                                        <label class="form-label">Number of Records</label>
                                        <input type="number"
                                               class="form-control"
                                               id="recordLimit"
                                               min="1"
                                               max="@ViewBag.observationCount"
                                               value="1000" />
                                        <div class="form-text text-muted">Enter a value between 1 and @ViewBag.observationCount</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Export Button -->
                <div class="mt-5">
                    <button type="button" class="btn btn-primary" id="exportButton">
                        <span class="indicator-label">Export Data</span>
                        <span class="indicator-progress">
                            Please wait...
                            <span class="spinner-border spinner-border-sm align-middle ms-2"></span>
                        </span>
                    </button>
                </div>
            </div>
            <!-- Available Columns -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Available Columns</h3>
                    </div>
                    <div class="card-body">
                        <div id="availableColumns" class="available-columns min-h-250px">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Style tanımlamaları
                                const style = `
            .hover-bg-secondary:hover {
                background-color: #f8f9fa !important;
            }
            .cursor-pointer {
                cursor: pointer;
            }
            .dragging {
                opacity: 0.5;
                cursor: move;
            }
            .drag-over {
                border: 2px dashed #009ef7 !important;
                background-color: rgba(0, 158, 247, 0.05);
            }
            .column-item {
                transition: all 0.2s ease;
            }
            .selected-columns {
                min-height: 150px;
                padding: 0.75rem;
                border: 1px dashed #dee2e6;
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
                align-items: flex-start;
            }
            .selected-column-item {
                display: inline-flex;
                align-items: center;
                padding: 0.35rem 0.75rem;
                background: #e8f3ff;
                border: 1px solid #b7d6ff;
                border-radius: 2rem;
                cursor: move;
                user-select: none;
                font-size: 0.875rem;
                color: #0066cc;
                margin: 0;
                transition: all 0.2s ease;
            }
            .selected-column-item .remove-column {
                width: 18px;
                height: 18px;
                padding: 0 !important;
                margin-left: 0.5rem;
                font-size: 0.75rem;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                background: transparent;
                border: none;
                color: #0066cc;
                transition: all 0.2s ease;
            }
            .selected-column-item .remove-column:hover {
                background: rgba(0, 102, 204, 0.1);
                color: #004c99;
            }
            .selected-column-item:hover {
                background: #d9ebff;
                border-color: #99c7ff;
            }
            .selected-column-item.dragging {
                opacity: 0.5;
                border: 1px dashed #009ef7;
                background: #f0f9ff;
            }
                    .form-check-input {
            width: 2rem !important;
            height: 2rem !important;
            border: 2px solid #B5B5C3 !important;
            cursor: pointer;
            margin: 0 !important;
        }

            .form-check-input:checked {
                background-color: var(--bs-primary) !important;
                border-color: var(--bs-primary) !important;
            }

                    .form-check-label {
            cursor: pointer;
            font-size: 1rem;
            margin: 0;
            padding-top: 8px;  /* Dikey hizalama için */
            user-select: none; /* Metni seçilemez yap */
        }
                    .form-check {
            cursor: pointer;
            padding-left: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
            input[readonly] {
                background-color: #f5f8fa !important;
                cursor: not-allowed !important;
                pointer-events: none;
            }

            .export-checkbox-container {
                padding: 0.5rem;
                margin-bottom: 1rem;
                display: flex;
                align-items: center;
            }

            input[type="checkbox"][readonly] {
                cursor: not-allowed !important;
             }
        #availableColumns {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            position: sticky;
            top: 20px;
        }

        .card {
            position: relative;
        }

        .available-columns {
            padding-right: 5px; /* Scroll bar için extra padding */
        }

        /* Scroll bar stilleri */
        .available-columns::-webkit-scrollbar {
            width: 6px;
        }

        .available-columns::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .available-columns::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .available-columns::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .remove-from-available {
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .remove-from-available:hover {
            opacity: 1;
        }

        .column-item:hover .remove-from-available {
            opacity: 0.9;
        }
        `;

        $('<style>').text(style).appendTo('head');

         $(document).ready(function() {
                $('#startDate, #endDate').prop('disabled', false);
                $('#recordLimit').prop('disabled', false);

            $('#exportAllDates').on('change', function() {
            const isChecked = $(this).is(':checked');
            if (isChecked) {
                $('#dateInputs').addClass('d-none');
                $('#startDate, #endDate').prop('disabled', true);
            } else {
                $('#dateInputs').removeClass('d-none');
                $('#startDate, #endDate').prop('disabled', false);
            }
        });

        $('#exportAllRecords').on('change', function() {
            const isChecked = $(this).is(':checked');
            if (isChecked) {
                $('#limitInputs').addClass('d-none');
                $('#recordLimit').prop('disabled', true);
            } else {
                $('#limitInputs').removeClass('d-none');
                $('#recordLimit').prop('disabled', false);
            }
        });

            try {
                fetch('/Export/GetColumnNames')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('MVC Response:', data);
                        if (data && data.data) {
                            console.log('Data to render:', data.data);
                            renderColumns(data.data);
                        } else {
                            console.error('Data structure is not as expected:', data);
                        }
                    })
                    .catch(error => {
                        console.error('MVC Error:', error);
                    });

                $("#exportButton").click(handleExport);

            } catch (error) {
                console.error('Error during initialization:', error);
                toastr.error("An error occurred during page initialization");
            }
        });

                function renderColumns(data) {
            const container = $('#availableColumns');
            container.empty();

            Object.keys(data).forEach(groupName => {
                const tableGroup = $(`
                    <div class="table-group mb-4">
                    <h5 class="fw-bold text-primary mb-2">${groupName}</h5>
                    <div class="column-list ps-2">
                    </div>
                    </div>
                `);

                         const columnList = tableGroup.find('.column-list');

                if (Array.isArray(data[groupName])) {
                    data[groupName].forEach(column => {
                        const columnItem = $(`
                            <div class="column-item p-2 mb-2 bg-light rounded cursor-pointer hover-bg-secondary"
                                 draggable="true"
                                 data-property-path="${column.propertyPath}"
                                 data-display-name="${column.displayName}"
                                 data-table-name="${groupName}">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>
                                        <i class="fas fa-grip-vertical me-2 text-muted"></i>
                                        <span>${column.displayName}</span>
                                    </div>
                                    <button type="button" class="btn btn-icon btn-sm btn-light-primary remove-from-available d-none">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        `);

                        columnItem.on('dragstart', function(e) {
                            e.originalEvent.dataTransfer.setData('text/plain', JSON.stringify({
                                propertyPath: column.propertyPath,
                                displayName: column.displayName,
                                tableName: groupName
                            }));
                            $(this).addClass('dragging');
                        });

                        columnItem.on('dragend', function() {
                            $(this).removeClass('dragging');
                        });

                        columnItem.find('.remove-from-available').click(function(e) {
                            e.stopPropagation();
                            const propertyPath = columnItem.data('property-path');
                            $(`.selected-column-item[data-property-path="${propertyPath}"]`).remove();
                            updateAvailableColumnButtons();
                        });

                        columnList.append(columnItem);
                    });
                }

                container.append(tableGroup);
            });

            setupDropZone();
            updateAvailableColumnButtons();
        }
        function updateAvailableColumnButtons() {
            // Reset all remove buttons
            $('.remove-from-available').addClass('d-none');

            // Show remove buttons for selected columns
            $('#selectedColumns .selected-column-item').each(function() {
                const propertyPath = $(this).data('property-path');
                $(`.column-item[data-property-path="${propertyPath}"] .remove-from-available`)
                    .removeClass('d-none');
            });
        }
                function setupDropZone() {
            const selectedColumns = $('#selectedColumns');
            selectedColumns.off();

            selectedColumns.on('dragover', function(e) {
                e.preventDefault();
                e.originalEvent.dataTransfer.dropEffect = 'move';
                $(this).addClass('drag-over');
            });

            selectedColumns.on('drop', function(e) {
                e.preventDefault();
                $(this).removeClass('drag-over');

                try {
                    const data = JSON.parse(e.originalEvent.dataTransfer.getData('text/plain'));
                    const existingColumn = $(`.selected-column-item[data-property-path="${data.propertyPath}"]`);

                    if (existingColumn.length === 0) {
                        const selectedColumn = createSelectedColumnItem(data);
                        setupDragForSelectedColumn(selectedColumn);
                        $(this).append(selectedColumn);
                        updateAvailableColumnButtons();
                    }
                } catch (error) {
                    console.error('Error during drop:', error);
                }
            });

            selectedColumns.on('dragleave', function() {
                $(this).removeClass('drag-over');
            });
        }

        function createSelectedColumnItem(data) {
            return $(`
                <div class="selected-column-item"
                     draggable="true"
                     data-property-path="${data.propertyPath}"
                     data-display-name="${data.displayName}"
                     data-table-name="${data.tableName}">
                    <span>${data.displayName}</span>
                    <button type="button" class="remove-column">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `);
        }
                function setupDragForSelectedColumn(column) {
            column.on('dragstart', function(e) {
                e.stopPropagation();
                $(this).addClass('dragging');
                e.originalEvent.dataTransfer.setData('text/plain', JSON.stringify({
                    propertyPath: $(this).data('property-path'),
                    displayName: $(this).data('display-name'),
                    tableName: $(this).data('table-name')
                }));
            });

            column.on('dragend', function() {
                $(this).removeClass('dragging');
            });

            column.on('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();

                const afterElement = getDragAfterElement($(this).parent(), e.clientX);
                const draggable = $('.dragging');

                if (draggable.length && draggable.hasClass('selected-column-item')) {
                    if (afterElement == null) {
                        $(this).parent().append(draggable);
                    } else {
                        $(afterElement).before(draggable);
                    }
                }
            });

            column.find('.remove-column').click(function() {
                column.remove();
                updateAvailableColumnButtons();
            });
        }

        function getDragAfterElement(container, x) {
            const draggableElements = [...container.find('.selected-column-item:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = x - box.left - box.width / 2;

                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

    function handleExport(e) {
            const button = $(e.currentTarget);
            const maxRecords = parseInt($('#recordLimit').attr('max'));
            const exportAllDates = $('#exportAllDates').is(':checked');
            const exportAllRecords = $('#exportAllRecords').is(':checked');

            const selectedColumns = [];
            $('#selectedColumns .selected-column-item').each(function() {
                const $this = $(this);
                selectedColumns.push({
                    propertyPath: $this.data('property-path'),
                    displayName: $this.data('display-name'),
                    tableName: $this.data('table-name')
                });
            });

            if (selectedColumns.length === 0) {
                toastr.warning("Please select at least one column to export");
                return;
            }

            let startDate = null;
            let endDate = null;
            let recordLimit = null;

            // Sadece "Export All Dates" seçili değilse tarih kontrolü yap
            if (!exportAllDates) {
                startDate = $('#startDate').val();
                endDate = $('#endDate').val();
                if (!startDate || !endDate) {
                    toastr.warning("Please select both start and end dates or check 'Export All Dates'");
                    return;
                }
            }

            // Sadece "Export All Records" seçili değilse kayıt limiti kontrolü yap
            if (!exportAllRecords) {
                recordLimit = parseInt($('#recordLimit').val());
                if (!recordLimit || recordLimit <= 0) {
                    toastr.warning("Please enter a valid record limit or check 'Export All Records'");
                    return;
                }
                if (recordLimit > maxRecords) {
                    toastr.warning(`Record limit cannot exceed ${maxRecords}`);
                    return;
                }
            }

            button.attr('data-kt-indicator', 'on');
            button.prop('disabled', true);

            const requestData = {
                columns: selectedColumns,
                startDate: startDate,
                endDate: endDate,
                recordLimit: recordLimit,
                exportAllDates: exportAllDates,
                exportAllRecords: exportAllRecords
            };

            fetch('/Export/ExportData', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (!response.ok) throw new Error('Export failed');
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `export_${new Date().toISOString().slice(0,10)}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                console.error('Export error:', error);
                toastr.error("An error occurred during export");
            })
            .finally(() => {
                button.removeAttr('data-kt-indicator');
                button.prop('disabled', false);
            });
        }
    </script>
}
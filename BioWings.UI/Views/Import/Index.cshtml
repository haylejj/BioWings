@{
    ViewData["Title"] = "Import Observations";
    Layout = "~/Views/MainLayout/Index.cshtml";
}

<!--begin::Card-->
<div class="card">
    <!--begin::Card header-->
    <div class="card-header border-0 pt-6">
        <div class="card-title">
            <h3 class="card-title align-items-start flex-column">
                <span class="card-label fw-bold text-dark">Import Observations</span>
                <span class="text-muted mt-1 fw-semibold fs-7">Upload your Excel files to import observations</span>
            </h3>
        </div>
        <div class="card-toolbar">
            <div class="d-flex justify-content-end">
                <a href="#" class="btn btn-light-primary me-3" data-bs-toggle="modal" data-bs-target="#importGuideModal">
                    <i class="bi bi-question-circle fs-4 me-1"></i>
                    Import Guide
                </a>
            </div>
        </div>
    </div>
    <!--end::Card header-->
    <!--begin::Card body-->
    <div class="card-body">
        <!--begin::Form-->
        <form id="importForm" class="form" enctype="multipart/form-data">
            <!--begin::Alert-->
            <div class="alert alert-primary d-flex align-items-center p-5 mb-10">
                <i class="bi bi-info-circle fs-2x text-primary me-4"></i>
                <div class="d-flex flex-column">
                    <span>Please ensure your Excel file follows the required format. Download the template if needed.</span>
                    <a href="#" id="downloadTemplate" class="text-primary fw-bold mt-2">Download Template</a>
                </div>
            </div>
            <!--end::Alert-->
            <!--begin::Upload area-->
            <div class="dropzone dz-clickable" id="importDropzone">
                <div class="dz-message needsclick">
                    <i class="bi bi-file-earmark-excel fs-3x text-primary"></i>
                    <div class="ms-4">
                        <h3 class="fs-5 fw-bold text-gray-900 mb-1">Drop files here or click to upload.</h3>
                        <span class="fs-7 fw-semibold text-gray-400 d-block">Upload Excel files only (.xlsx, .xls)</span>
                        <span class="fs-7 fw-semibold text-gray-400 d-block">Maximum file size: 50MB</span>
                    </div>
                </div>
            </div>
            <!--end::Upload area-->
            <!--begin::Progress-->
            <div id="importProgress" class="d-none mt-5">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <div class="d-flex align-items-center">
                        <span id="progressText" class="text-muted me-3 fs-6">Processing...</span>
                        <span id="progressPercentage" class="text-muted fs-6 fw-bold">0%</span>
                    </div>
                    <button type="button" class="btn btn-sm btn-icon btn-light" id="cancelProgress">
                        <i class="bi bi-x fs-2"></i>
                    </button>
                </div>
                <div class="progress h-6px w-100">
                    <div id="progressBar" class="progress-bar bg-primary" role="progressbar" style="width: 0%"
                         aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
            <!--end::Progress-->
            <!--begin::Results-->
            <div id="importResults" class="d-none mt-5">
                <div class="separator separator-dashed my-5"></div>
                <div class="d-flex flex-column">
                    <div class="d-flex align-items-center mb-2">
                        <span class="bullet bullet-vertical h-40px bg-success"></span>
                        <div class="flex-grow-1 ms-5">
                            <span id="successCount" class="text-gray-800 fw-bold fs-6">0</span>
                            <span class="text-muted fw-semibold d-block">Records imported successfully</span>
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="bullet bullet-vertical h-40px bg-danger"></span>
                        <div class="flex-grow-1 ms-5">
                            <span id="errorCount" class="text-gray-800 fw-bold fs-6">0</span>
                            <span class="text-muted fw-semibold d-block">Failed records</span>
                        </div>
                    </div>
                </div>
                <!--begin::Error Details-->
                <div class="mt-5" id="errorDetails" style="display: none;">
                    <span class="text-muted fw-bold fs-6">Error Details:</span>
                    <div class="text-danger mt-2" id="errorMessage"></div>
                </div>
                <!--end::Error Details-->
            </div>
            <!--end::Results-->
            <!--begin::Actions-->
            <div class="text-center mt-8">
                <button type="reset" class="btn btn-light me-3" id="cancelButton">
                    <span class="indicator-label">Cancel</span>
                </button>
                <button type="submit" class="btn btn-primary" id="submitButton" data-kt-indicator="off">
                    <span class="indicator-label">Import Data</span>
                    <span class="indicator-progress">
                        Please wait...
                        <span class="spinner-border spinner-border-sm align-middle ms-2"></span>
                    </span>
                </button>
            </div>
            <!--end::Actions-->
        </form>
        <!--end::Form-->
    </div>
    <!--end::Card body-->
</div>
<!--end::Card-->
<!--begin::Modal-->
<div class="modal fade" id="importGuideModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-650px">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Import Guide</h2>
                <div class="btn btn-sm btn-icon btn-active-color-primary" data-bs-dismiss="modal">
                    <i class="bi bi-x fs-1"></i>
                </div>
            </div>
            <div class="modal-body scroll-y mx-5 mx-xl-15 my-7">
                <div class="mb-5">
                    <h4 class="fw-bold text-dark mb-3">Excel File Requirements:</h4>
                    <ul class="fs-6 fw-semibold mb-5">
                        <li>File must be in .xlsx or .xls format</li>
                        <li>Maximum file size is 50MB</li>
                        <li>Follow the template structure</li>
                        <li>Required fields must not be empty</li>
                    </ul>
                </div>
                <div class="mb-5">
                    <h4 class="fw-bold text-dark mb-3">Steps to Import:</h4>
                    <ol class="fs-6 fw-semibold">
                        <li>Download the template (if needed)</li>
                        <li>Fill in your data following the template format</li>
                        <li>Drag and drop or click to upload your file</li>
                        <li>Click "Import Data" to start the import process</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script src="~/lib/dropzone/dropzone.min.js"></script>
    <script>

                "use strict";

        var ImportHandler = function () {
            // Private variables
            const API_URL = 'https://localhost:7128/api/Observations/ImportAllFormat';
            var submitButton;
            var cancelButton;
            var progressElement;
            var progressBar;
            var progressText;
            var progressPercentage;
            var resultsElement;
            var successCount;
            var errorCount;
            var dropzone;

            // Dropzone configuration
            const initDropzone = () => {
                dropzone = new Dropzone("#importDropzone", {
                    url: "#",
                    paramName: "file",
                    maxFiles: 1,
                    maxFilesize: 50,
                    acceptedFiles: ".xlsx,.xls",
                    autoProcessQueue: false,
                    addRemoveLinks: true,
                    createImageThumbnails: false,
                    headers: {
                        'Accept': 'application/json'
                    },
                    init: function() {
                        this.on("addedfile", function(file) {
                            if (this.files.length > 1) {
                                this.removeFile(this.files[0]);
                            }
                            submitButton.disabled = false;
                        });

                        this.on("removedfile", function() {
                            submitButton.disabled = true;
                            resetUI();
                        });

                        this.on("error", function(file, errorMessage) {
                            toastr.error(errorMessage);
                        });
                    },
                    dictDefaultMessage: "Drop Excel files here or click to upload",
                    dictFileTooBig: "File is too big ({{filesize}}MB). Max filesize: {{maxFilesize}}MB.",
                    dictInvalidFileType: "Only Excel files (.xlsx, .xls) are allowed.",
                    dictMaxFilesExceeded: "Only one file can be uploaded at a time.",
                    dictRemoveFile: "Remove file",
                    dictCancelUpload: "Cancel upload"
                });
            };

            // Reset UI state
            const resetUI = () => {
                progressElement.classList.add('d-none');
                resultsElement.classList.add('d-none');
                submitButton.removeAttribute('data-kt-indicator');
                updateProgress(0);
                progressText.textContent = "Processing...";
                successCount.textContent = "0";
                errorCount.textContent = "0";
            };

            // Handle form submission
            const handleSubmit = () => {
                submitButton.addEventListener('click', async e => {
                    e.preventDefault();

                    if (dropzone.files.length === 0) {
                        toastr.error("Please select a file to import");
                        return;
                    }

                    const formData = new FormData();
                    formData.append('file', dropzone.files[0]);

                    try {
                        submitButton.setAttribute('data-kt-indicator', 'on');
                        submitButton.disabled = true;
                        progressElement.classList.remove('d-none');
                        resultsElement.classList.add('d-none');

                        const response = await fetch(API_URL, {
                            method: 'POST',
                            body: formData,
                            credentials: 'include'
                        });

                        const result = await response.json();

                        if (!response.ok) {
                            throw new Error(result.message || `Import failed with status: ${response.status}`);
                        }

                        if (result.isSuccess) {
                            successCount.textContent = result.data?.successCount || 0;
                            errorCount.textContent = result.data?.errorCount || 0;
                            resultsElement.classList.remove('d-none');
                            toastr.success("Import completed successfully!");
                            dropzone.removeAllFiles();
                        } else {
                            toastr.error(result.message || "Import failed");
                            errorCount.textContent = result.data?.errorCount || 0;
                            resultsElement.classList.remove('d-none');
                        }

                        updateProgress(100);
                    } catch (error) {
                        console.error('Import error:', error);
                        toastr.error(error.message || "An error occurred during import");
                    } finally {
                        submitButton.removeAttribute('data-kt-indicator');
                        submitButton.disabled = !dropzone.files.length;
                        progressElement.classList.add('d-none');
                    }
                });
            };

            // Update progress bar
            const updateProgress = (value) => {
                const percent = Math.min(100, Math.max(0, value));
                progressBar.style.width = percent + '%';
                progressBar.setAttribute('aria-valuenow', percent);
                progressPercentage.textContent = percent + '%';

                if (percent === 100) {
                    progressText.textContent = "Processing complete";
                }
            };

            // Handle cancel operation
            const handleCancel = () => {
                cancelButton.addEventListener('click', e => {
                    e.preventDefault();
                    dropzone.removeAllFiles(true);
                    resetUI();
                    submitButton.disabled = true;
                    toastr.info("Import cancelled");
                });
            };

            // Public methods
            return {
                init: function () {
                    submitButton = document.querySelector('#submitButton');
                    cancelButton = document.querySelector('#cancelButton');
                    progressElement = document.querySelector('#importProgress');
                    progressBar = document.querySelector('#progressBar');
                    progressText = document.querySelector('#progressText');
                    progressPercentage = document.querySelector('#progressPercentage');
                    resultsElement = document.querySelector('#importResults');
                    successCount = document.querySelector('#successCount');
                    errorCount = document.querySelector('#errorCount');

                    submitButton.disabled = true;

                    initDropzone();
                    handleSubmit();
                    handleCancel();
                }
            };
        }();

        // Initialize on document ready
        KTUtil.onDOMContentLoaded(function () {
            ImportHandler.init();
        });

    </script>
    <script>
                // Import sayfasındaki download template linkine click handler ekle
        document.querySelector('#downloadTemplate').addEventListener('click', async (e) => {
            e.preventDefault();

            try
            {
                const response = await fetch('https://localhost:7128/api/ExcelTemplate/download', {
            method: 'GET',
            headers: {
                'Accept': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
            },
            credentials: 'same-origin' // 'include' yerine 'same-origin' kullanın
        });
                    if (!response.ok) throw new Error('Download failed');

                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = "observation_import_template.xlsx";
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();

                    toastr.success('Template downloaded successfully');
               } catch (error) {
                    console.error('Download error:', error);
                    toastr.error('Failed to download template');
                }
            });
    </script>
}

@section Styles {
    <link href="~/lib/dropzone/dropzone.min.css" rel="stylesheet" type="text/css" />
    <style>
        .dropzone {
            border: 2px dashed #009ef7;
            border-radius: 6px;
            padding: 20px;
            min-height: 200px;
            background: #f9f9f9;
        }

            .dropzone .dz-message {
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 2em 0;
            }

        .progress {
            background-color: #f5f8fa;
        }

        .dz-preview {
            margin: 1em;
        }

            .dz-preview .dz-details {
                padding: 1em;
            }
    </style>
}
